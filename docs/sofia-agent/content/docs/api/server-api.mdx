---
title: Server API
description: Documentation for SOFIA's HTTP and WebSocket API endpoints
---

# Server API

SOFIA provides a comprehensive set of API endpoints for interacting with agents. The API is built using FastAPI and supports both HTTP REST endpoints and WebSocket connections for real-time communication.

## API Overview

The SOFIA API server provides these main categories of endpoints:

1. **Session Management Endpoints** - Create, interact with, and manage sessions
2. **Chat Endpoints** - Stateless chat interactions where the client maintains session state
3. **WebSocket Endpoints** - Real-time bidirectional communication

## Session Management Endpoints

These endpoints allow server-side management of agent sessions. The server maintains the session state between requests.

### Create Session

Creates a new agent session.

```
POST /session
```

#### Query Parameters

| Parameter | Type    | Description                                      |
|-----------|---------|--------------------------------------------------|
| initiate  | boolean | Whether to get an initial greeting from the agent |

#### Response

```json
{
  "session_id": "uuid-string",
  "message": {
    // If initiate=true: Agent's initial message
    // Otherwise: { "status": "Session created successfully" }
  }
}
```

### Send Message to Session

Sends a message to an existing session.

```
POST /session/{session_id}/message
```

#### Request Body

```json
{
  "content": "User message text"
}
```

#### Response

```json
{
  "session_id": "uuid-string",
  "message": {
    "action": "answer | ask | tool_call | move",
    "input": "Agent's response text",
    // Additional fields depending on action type
  }
}
```

### End Session

Ends and cleans up a session.

```
DELETE /session/{session_id}
```

#### Response

```json
{
  "message": "Session ended successfully"
}
```

### Get Session History

Retrieves the conversation history of a session.

```
GET /session/{session_id}/history
```

#### Response

```json
{
  "session_id": "uuid-string",
  "history": [
    {
      "role": "user | assistant",
      "content": "Message content",
      // Additional message metadata
    },
    // More messages
  ]
}
```

## Chat Endpoint

The chat endpoint provides a stateless interface where the client maintains the session state. This is useful for integrations where you want to manage the session state yourself or need to persist it client-side.

### Chat

Gets the next response from the agent based on the provided session data.

```
POST /chat
```

#### Query Parameters

| Parameter | Type    | Description                              |
|-----------|---------|------------------------------------------|
| verbose   | boolean | Whether to include detailed output information |

#### Request Body

```json
{
  "user_input": "User message text",
  "session_data": {
    "session_id": "unique-id",
    "current_step_id": "flow-step-id",
    "history": [] // Previous messages
  }
}
```

#### Response

```json
{
  "response": {
    "action": "answer | ask | tool_call | move",
    "input": "Agent's response text",
    // Additional fields depending on action type
  },
  "tool_output": null, // Or tool output if a tool was called
  "session_data": {
    "session_id": "unique-id",
    "current_step_id": "flow-step-id",
    "history": [] // Updated history
  }
}
```

## WebSocket Endpoint

The WebSocket endpoint provides real-time bidirectional communication with an agent session.

### WebSocket Connection

Establishes a WebSocket connection to an agent session.

```
WS /ws/{session_id}
```

#### Query Parameters

| Parameter | Type    | Description                                      |
|-----------|---------|--------------------------------------------------|
| initiate  | boolean | Whether to get an initial greeting from the agent |
| verbose   | boolean | Whether to include detailed output information    |

#### Message Format (Client to Server)

```json
{
  "message": "User message text"
}
```

or

```json
{
  "close": true
}
```

#### Message Format (Server to Client)

```json
{
  "message": {
    "action": "answer | ask | tool_call | move",
    "input": "Agent's response text",
    // Additional fields depending on action type
  },
  "tool_output": null, // Or tool output if a tool was called
  "type": "answer | tool_call | step_transition | error"
}
```

## Error Handling

All endpoints follow standard HTTP status codes:

- **200 OK** - The request was successful
- **404 Not Found** - Session not found or resource doesn't exist
- **422 Unprocessable Entity** - Invalid request data
- **500 Internal Server Error** - Server-side error

Error responses include a detail message explaining what went wrong.

## Security Considerations

When deploying SOFIA agents in production, consider these security measures:

1. **API Authentication** - Implement API keys or OAuth2 for authentication
2. **CORS Configuration** - Configure proper CORS settings via the `ALLOWED_ORIGINS` environment variable
3. **Rate Limiting** - Implement rate limiting to prevent abuse
4. **Input Validation** - All inputs are validated through Pydantic models, but consider additional validation
5. **HTTPS** - Always use HTTPS in production environments

## API Versioning

The current API version is v0.1.1. The version is included in the response headers and in the OpenAPI documentation.

## Example Usage

### cURL Examples

**Create a new session:**

```bash
curl -X POST "http://localhost:8000/session?initiate=true" \
  -H "Content-Type: application/json"
```

**Send a message to a session:**

```bash
curl -X POST "http://localhost:8000/session/your-session-id/message" \
  -H "Content-Type: application/json" \
  -d '{"content": "Hello, how can you help me?"}'
```

**Get session history:**

```bash
curl -X GET "http://localhost:8000/session/your-session-id/history"
```

**End a session:**

```bash
curl -X DELETE "http://localhost:8000/session/your-session-id"
```

**Use the chat endpoint:**

```bash
curl -X POST "http://localhost:8000/chat" \
  -H "Content-Type: application/json" \
  -d '{
    "user_input": "Hello there",
    "session_data": {
      "session_id": "unique-id",
      "current_step_id": "start",
      "history": []
    }
  }'
```

### JavaScript WebSocket Example

```javascript
const socket = new WebSocket('ws://localhost:8000/ws/your-session-id?initiate=true');

socket.onopen = () => {
  console.log('Connected to agent');
};

socket.onmessage = (event) => {
  const data = JSON.parse(event.data);
  console.log('Received message:', data);
};

// Send a message
socket.send(JSON.stringify({ message: "Hello, agent!" }));

// Close the connection
socket.send(JSON.stringify({ close: true }));
```

## API Playground

For interactive testing, you can use the OpenAPI documentation at `/docs` when running the SOFIA server. This provides a comprehensive UI for exploring and testing all API endpoints.
